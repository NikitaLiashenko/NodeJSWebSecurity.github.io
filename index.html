<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>nodejswebsecurity.github.io by NikitaLiashenko</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">nodejswebsecurity.github.io</h1>
      <h2 class="project-tagline">Short doc about Securing Node.JS App based on Karl Duuna&#39;s &quot;Secure your Node.JS Web Application&quot; book.</h2>
      <a href="https://github.com/NikitaLiashenko/NodeJSWebSecurity.github.io" class="btn">View on GitHub</a>
      <a href="https://github.com/NikitaLiashenko/NodeJSWebSecurity.github.io/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/NikitaLiashenko/NodeJSWebSecurity.github.io/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="currently-not-finished" class="anchor" href="#currently-not-finished" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Currently not finished</h3>

<h1>
<a id="all-code-was-brought-from-the-book-author-is-karl-duuna-published-by-the-pragmatic-bookshelf" class="anchor" href="#all-code-was-brought-from-the-book-author-is-karl-duuna-published-by-the-pragmatic-bookshelf" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>All code was brought from the book. Author is Karl Duuna. Published by The Pragmatic Bookshelf.</h1>

<h1>
<a id="security-list" class="anchor" href="#security-list" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security List</h1>

<ul>
<li>Web application should not be run with root priviledges.</li>
<li>DB account should not be root account.</li>
<li>The users of web app should be given the minimum set of priviledges.</li>
<li>Use dedicated mashines. Mashine should host your app only.Don't use it for anything else.</li>
<li>Keep access to the production server to a minimum.</li>
<li>Don't use any default passwords or keys.Use keys generated by you.</li>
<li>Set up propper firewall. 
(HOW???)NEED MORE INFO</li>
<li>
<p>Keep packages up-to-date</p>

<p><em>check linux server security</em></p>
</li>
<li><p>Use separate development and production servers as well as DBs</p></li>
<li>Use configuration tools(like nconf module)</li>
<li>Limit error messages in production</li>
<li>Determine every module version</li>
<li>Transport layer security</li>
<li>Don't use self-signed SSl certificates in production (at least use <a href="http://startssl.com">StartSSL</a>)</li>
<li>If you use HTTPS(use it every time), you should make simple HTTP redirect server</li>
<li>Use nginx to handle ssl connection.It's too hard for Node.</li>
<li>
<p>Use HSTS
Set Strict-Transport-Security header like this:</p>

<pre><code>    res.set('Strict-Transport-Security', 'max-age=' + &lt;put time in seconds&gt; + ';includeSubdomains');
</code></pre>

<p>This will work only if you send it over HTTPS and have proper certificate(not self-signed)
If you use nginx, you should set protection headers in the proxy configuration.</p>

<p><em>check mozilla HSTS article</em></p>
</li>
<li>
<p>Use morgan as logging system.It will help to check requests and know, how thee attack was made.</p>

<pre><code>    app.use(morgan('combined'));
</code></pre>

<p><code>combined</code> is the best option for logging</p>

<p><em>check morgan and mongo-morgan API</em></p>
</li>
<li><p>Every emitter must have error listener</p></li>
<li>Try to avoid creating any code using user-submitted data(don't believe user-submitted data)</li>
<li>If you should exec something:

<ol>
<li>try to change exec to execFile</li>
<li>validate input</li>
<li>limit run rights</li>
</ol>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> opts <span class="pl-k">=</span> {};
<span class="pl-smi">app</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">'</span>/host<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-c">// Add options specifying uid, which we asked from system</span>
    <span class="pl-en">execFile</span>(<span class="pl-s"><span class="pl-pds">'</span>/usr/bin/host<span class="pl-pds">'</span></span>, [<span class="pl-smi">req</span>.<span class="pl-c1">body</span>.<span class="pl-c1">host</span>],
        opts, <span class="pl-k">function</span> (<span class="pl-smi">err</span>, <span class="pl-smi">stdout</span>, <span class="pl-smi">stderr</span>) {
            <span class="pl-k">if</span>(err <span class="pl-k">||</span> stderr) {
                <span class="pl-en">console</span>.<span class="pl-c1">error</span>(err <span class="pl-k">||</span> stderr);
                <span class="pl-smi">res</span>.<span class="pl-en">sendStatus</span>(<span class="pl-c1">500</span>);
                <span class="pl-k">return</span>;
            }
            <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(
                <span class="pl-s"><span class="pl-pds">'</span>&lt;h3&gt;Lookup for: <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">req</span>.<span class="pl-c1">body</span>.<span class="pl-c1">host</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/h3&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                <span class="pl-s"><span class="pl-pds">'</span>&lt;pre&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span> stdout <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/pre&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                form
            );
        });
});
<span class="pl-c">// Look for the nobody user</span>
<span class="pl-c">// NOTE:</span>
<span class="pl-c">// On OSX this can cause an error because the UID of nobody</span>
<span class="pl-c">// is a negative number (-1) represented by overflowing integer</span>
<span class="pl-en">execFile</span>(<span class="pl-s"><span class="pl-pds">'</span>/usr/bin/id<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>-u<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>nobody<span class="pl-pds">'</span></span>], <span class="pl-k">function</span> (<span class="pl-smi">err</span>, <span class="pl-smi">stdout</span>, <span class="pl-smi">stderr</span>) {
    <span class="pl-k">if</span>(err <span class="pl-k">||</span> stderr) {
        <span class="pl-en">console</span>.<span class="pl-c1">error</span>(err <span class="pl-k">||</span> stderr);
        <span class="pl-c1">process</span>.<span class="pl-en">exit</span>(<span class="pl-c1">1</span>);
    }
    <span class="pl-c">// Set the uid in the options</span>
    <span class="pl-smi">opts</span>.<span class="pl-smi">uid</span> <span class="pl-k">=</span> <span class="pl-k">+</span>stdout;
    <span class="pl-c">// Start server</span>
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Nobody is <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">opts</span>.<span class="pl-smi">uid</span>);
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Listening on 3000<span class="pl-pds">'</span></span>);
    <span class="pl-smi">app</span>.<span class="pl-en">listen</span>(<span class="pl-c1">3000</span>);
});</pre></div>
</li>
<li>
<p>Use <code>express-ipfilter</code> module if you see attack from certain IP-address</p>

<p><em>check <code>express-ipfilter</code> module</em></p>
</li>
<li>
<p>Set special roles for every user in DB</p>

<p><em>check <code>mongoose-multitenant</code> or something like this</em></p>
</li>
<li>
<p>Defend from SQL injection:</p>

<ol>
<li>Reduce error messages in production</li>
<li>Validate all inputs</li>
<li>Escape user input</li>
<li>Use prepared queries (if it's possible)</li>
</ol>
</li>
<li>
<p>Defend from NoSQL injections:</p>

<ol>
<li>Validate inputs</li>
<li>Escape inputs</li>
</ol>

<p><em>check hacking and attacking Node.JS and MongoDB articles</em></p>
</li>
<li><p>Don't use MongoDB everywhere.It's not good for everything</p></li>
<li>
<p>One problem with mongo is concurent attack</p>

<p><em>check how to avoid</em></p>
</li>
<li><p>Never store passwords in plain text</p></li>
<li>Don't use MD5, SHA1, SHA256, SHA512 and SHA3 for hashing. All this algos designed to calculate hash as fast as possible. (use <code>bcrypt</code> or <code>scrypt</code> instead. <code>scrypt</code> is better)</li>
<li>You can upgrade storing password with MongoDB prehooks and validate password using MongoDB custom methods, or you can use classic API routes? put all this functionality in route and use MongoDB as store only.</li>
<li>Check user passwords itself. Password must not contain username. Password must not be in a <a href="https://wiki.skullsecurity.org/index.php?title=Passwords">List of bad passwords</a>
</li>
<li>Instead of forsing user to create password with special characters, that are hard to remember, have them select longer passwords. Changing password periodically is good suggestion (If you use it don't let users to write previously used passwords.keep the previous hashes and compare the hash of the new one to make sure the user isnâ€™t trying to reuse the password.)</li>
<li>Use HTTPS not only for login and register pages, but for the whole site. Your session will be stolen if you use HTTP for the other pages.</li>
<li>Do not send a plain-text password to the user's email as a reminder.</li>
<li>If application is generating password on the user's behalf, force the user to change it immediately the first time user logs in.</li>
<li>
<p>Insert delays in login system. You can block ip after some failed attempts, but use it carefully. Also you can secure app against parallel checks.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> maxFailedCount <span class="pl-k">=</span> <span class="pl-c1">5</span>; <span class="pl-c">// Max tries</span>
<span class="pl-k">var</span> forgetFailedMins <span class="pl-k">=</span> <span class="pl-c1">15</span>; <span class="pl-c">// time the user will be blocked</span>
<span class="pl-k">var</span> blockList <span class="pl-k">=</span> {};
<span class="pl-c">// Check if ip is still allowed</span>
<span class="pl-k">function</span> <span class="pl-en">isAllowed</span>(<span class="pl-smi">ip</span>) {
   <span class="pl-k">return</span> <span class="pl-k">!</span>blockList[ip] <span class="pl-k">||</span> blockList[ip].<span class="pl-smi">count</span> <span class="pl-k">&lt;</span> maxFailedCount;
}
<span class="pl-c">// Remove ip from blockList</span>
<span class="pl-k">function</span> <span class="pl-en">successfulAttempt</span>(<span class="pl-smi">ip</span>) {
   <span class="pl-k">if</span>(blockList[ip]) {
       <span class="pl-k">if</span>(blockList[ip].<span class="pl-smi">timeout</span>) {
           <span class="pl-c1">clearTimeout</span>(blockList[ip].<span class="pl-smi">timeout</span>);
       }
       <span class="pl-k">delete</span> blockList[ip];
   }
}
<span class="pl-c">// Increment blocklist counter</span>
<span class="pl-k">function</span> <span class="pl-en">failedAttempt</span>(<span class="pl-smi">ip</span>) {
   <span class="pl-k">if</span>(<span class="pl-k">!</span>blockList[ip]) {
       blockList[ip] <span class="pl-k">=</span> {
           count<span class="pl-k">:</span> <span class="pl-c1">0</span>
       };
   }
   blockList[ip].<span class="pl-smi">count</span><span class="pl-k">++</span>;
   <span class="pl-k">if</span>(blockList[ip].<span class="pl-smi">timeout</span>) {
       <span class="pl-c1">clearTimeout</span>(blockList[ip].<span class="pl-smi">timeout</span>);
   }
   blockList[ip].<span class="pl-smi">timeout</span> <span class="pl-k">=</span> <span class="pl-c1">setTimeout</span>(<span class="pl-k">function</span> () {
       <span class="pl-k">delete</span> blockList[ip];
   }, forgetFailedMins <span class="pl-k">*</span> <span class="pl-c1">60</span> <span class="pl-k">*</span> <span class="pl-c1">1000</span>);
}
<span class="pl-smi">app</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
   <span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-en">isAllowed</span>(<span class="pl-smi">req</span>.<span class="pl-smi">ip</span>)) { <span class="pl-c">// Check if user is blocked</span>
       <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">error</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>You have been blocked for <span class="pl-pds">'</span></span> <span class="pl-k">+</span>
           forgetFailedMins <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> minutes<span class="pl-pds">'</span></span>;
       <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>);
       <span class="pl-k">return</span>;
   }
   <span class="pl-en">validateUser</span>(<span class="pl-smi">req</span>.<span class="pl-c1">body</span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">valid</span>) {
       <span class="pl-k">if</span>(err) {
           <span class="pl-en">next</span>(err);
           <span class="pl-k">return</span>;
       }
       <span class="pl-k">if</span>(<span class="pl-smi">valid</span>.<span class="pl-smi">success</span>) { <span class="pl-c">// Validation success. Create authorized session.</span>
           <span class="pl-en">successfulAttempt</span>(<span class="pl-smi">req</span>.<span class="pl-smi">ip</span>); <span class="pl-c">// Clear from blocklist</span>
           <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">login</span>({userId<span class="pl-k">:</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>}, <span class="pl-k">function</span> () {
               <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/user/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>);
           });
       } <span class="pl-k">else</span> {
           <span class="pl-en">failedAttempt</span>(<span class="pl-smi">req</span>.<span class="pl-smi">ip</span>); <span class="pl-c">// Register the failed attempt</span>
           <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">error</span> <span class="pl-k">=</span> <span class="pl-smi">valid</span>.<span class="pl-smi">error</span>;
           <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>);
       }
   });
});</pre></div>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">function</span> <span class="pl-en">end</span>(<span class="pl-smi">url</span>) {
        <span class="pl-c1">setTimeout</span>(<span class="pl-k">function</span> () {
            <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(url);
        }, <span class="pl-c1">1000</span>);
    }
    <span class="pl-en">validateUser</span>(<span class="pl-smi">req</span>.<span class="pl-c1">body</span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">valid</span>) {
        <span class="pl-k">if</span>(err) {
            <span class="pl-en">next</span>(err);
            <span class="pl-k">return</span>;
        }
        <span class="pl-k">if</span>(<span class="pl-smi">valid</span>.<span class="pl-smi">success</span>) { <span class="pl-c">// Validation success. Create authorized session.</span>
            <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">login</span>({userId<span class="pl-k">:</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>}, <span class="pl-k">function</span> () {
                <span class="pl-c">// delay before answer</span>
                <span class="pl-en">end</span>(<span class="pl-s"><span class="pl-pds">'</span>/user/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>);
            });
        } <span class="pl-k">else</span> {
            <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">error</span> <span class="pl-k">=</span> <span class="pl-smi">valid</span>.<span class="pl-smi">error</span>;
            <span class="pl-c">// delay before answering</span>
            <span class="pl-en">end</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>);
        }
    });
});</pre></div>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> inProgress <span class="pl-k">=</span> {};
<span class="pl-smi">app</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">var</span> key <span class="pl-k">=</span> <span class="pl-smi">req</span>.<span class="pl-smi">ip</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>:<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">req</span>.<span class="pl-c1">body</span>.<span class="pl-smi">username</span>;
    <span class="pl-c">// check if we are already authenticating this user from the given IP</span>
    <span class="pl-k">if</span>(inProgress[key]) {
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">error</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Authentication already in progress<span class="pl-pds">'</span></span>;
        <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>);
        <span class="pl-k">return</span>;
    }
    inProgress[key] <span class="pl-k">=</span> <span class="pl-c1">true</span>;
    <span class="pl-k">function</span> <span class="pl-en">end</span>(<span class="pl-smi">url</span>) {
        <span class="pl-c1">setTimeout</span>(<span class="pl-k">function</span> () {
            <span class="pl-k">delete</span> inProgress[key];
            <span class="pl-smi">res</span>.<span class="pl-en">redirect</span>(url);
        }, <span class="pl-c1">1000</span>);
    }
    <span class="pl-en">validateUser</span>(<span class="pl-smi">req</span>.<span class="pl-c1">body</span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">valid</span>) {
        <span class="pl-k">if</span>(err) {
            <span class="pl-k">delete</span> inProgress[key];
            <span class="pl-en">next</span>(err);
            <span class="pl-k">return</span>;
        }
        <span class="pl-k">if</span>(<span class="pl-smi">valid</span>.<span class="pl-smi">success</span>) { <span class="pl-c">// Validation success. Create authorized session.</span>
            <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">login</span>({userId<span class="pl-k">:</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>}, <span class="pl-k">function</span> () {
                <span class="pl-c">// delay before answer</span>
                <span class="pl-en">end</span>(<span class="pl-s"><span class="pl-pds">'</span>/user/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">valid</span>.<span class="pl-smi">userId</span>);
            });
        } <span class="pl-k">else</span> {
            <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">error</span> <span class="pl-k">=</span> <span class="pl-smi">valid</span>.<span class="pl-smi">error</span>;
            <span class="pl-c">// delay before answering</span>
            <span class="pl-en">end</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>);
        }
    });
});</pre></div>
</li>
<li>If login failed don't say, which field is incorrect</li>
<li>If you have email-based recovery system, always validate user's email address. Don't let user change it without revalidating.</li>
<li>
<p>You can have two-password authentication.One password you use for real authentication,  the other you will use for special requests.</p>

<p><em>check OWASP session management cheat sheet</em></p>
</li>
<li>
<p>Use <code>connect-redis</code> for storing sessions</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> express <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> RedisStore <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>connect-redis<span class="pl-pds">'</span></span>)(express); <span class="pl-c">// Require connect-redis</span>
<span class="pl-k">var</span> session <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express-session<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> cookieParser <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>cookie-parser<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> app <span class="pl-k">=</span> <span class="pl-en">express</span>();
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">cookieParser</span>());
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">session</span>({
        store<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">RedisStore</span>({
        host<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>localhost<span class="pl-pds">'</span></span>,
        port<span class="pl-k">:</span> <span class="pl-c1">6379</span>,
        db<span class="pl-k">:</span> <span class="pl-c1">2</span>,
        pass<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>funky password here<span class="pl-pds">'</span></span> <span class="pl-c">// &lt;- specify password</span>
    }),
    secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>this is a nice secret<span class="pl-pds">'</span></span>,
    resave<span class="pl-k">:</span> <span class="pl-c1">false</span>,
    saveUninitialized<span class="pl-k">:</span> <span class="pl-c1">true</span>
}));</pre></div>
</li>
<li>In <code>express-session</code> use more generic name prop value ( 'id' ) for not to share info about application</li>
<li>
<p>Set session timeout to 5 minutes if it's highly protected applications and no more than twenty minutes for low-risk applications.
Also you can use two-tier system which gives you full access right after login, but reduce your access after a few minutes</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> session <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express-session<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> RedisStore <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>connect-redis<span class="pl-pds">'</span></span>)(session); <span class="pl-c">// Require connect-redis</span>
<span class="pl-c">// Extend the Session prototype with some custom functions</span>
<span class="pl-c">// Add a login function</span>
<span class="pl-smi">session</span>.<span class="pl-smi">Session</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">login</span> <span class="pl-k">=</span> <span class="pl-k">function</span> <span class="pl-en">login</span>() {
    <span class="pl-c">// Set a time of login</span>
    <span class="pl-v">this</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_loggedInAt</span> <span class="pl-k">=</span> <span class="pl-c1">Date</span>.<span class="pl-en">now</span>();
};
<span class="pl-c">// Add a function to check the logged in status of the user</span>
<span class="pl-smi">session</span>.<span class="pl-smi">Session</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">isLoggedIn</span> <span class="pl-k">=</span> <span class="pl-k">function</span> <span class="pl-en">isLoggedIn</span>() {
    <span class="pl-k">return</span> <span class="pl-k">!!</span><span class="pl-v">this</span>.<span class="pl-smi">_loggedInAt</span>;
};
<span class="pl-c">// Add a function to check the freshness of the session</span>
<span class="pl-smi">session</span>.<span class="pl-smi">Session</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">isFresh</span> <span class="pl-k">=</span> <span class="pl-k">function</span> <span class="pl-en">isFresh</span>() {
    <span class="pl-c">// Return true if logged in less then 3 minutes ago</span>
    <span class="pl-k">return</span> (<span class="pl-v">this</span>.<span class="pl-smi">_loggedInAt</span> <span class="pl-k">&amp;&amp;</span> (<span class="pl-c1">Date</span>.<span class="pl-en">now</span>() <span class="pl-k">-</span> <span class="pl-v">this</span>.<span class="pl-smi">_loggedInAt</span>) <span class="pl-k">&lt;</span> (<span class="pl-c1">1000</span> <span class="pl-k">*</span> <span class="pl-c1">60</span> <span class="pl-k">*</span> <span class="pl-c1">3</span>));
};
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">cookieParser</span>());
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">session</span>({
    store<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">RedisStore</span>({ <span class="pl-c">// specify the usage of RedisStore</span>
        host<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>localhost<span class="pl-pds">'</span></span>,
        port<span class="pl-k">:</span> <span class="pl-c1">6379</span>,
        db<span class="pl-k">:</span> <span class="pl-c1">2</span>,
        pass<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>funky password here<span class="pl-pds">'</span></span>, <span class="pl-c">//  specify password</span>
        ttl<span class="pl-k">:</span> (<span class="pl-c1">20</span> <span class="pl-k">*</span> <span class="pl-c1">60</span>) <span class="pl-c">// TTL of 20 minutes represented in seconds</span>
    }),
    name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>, <span class="pl-c">// use a generic id</span>
    secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>this is a nice secret<span class="pl-pds">'</span></span>,
    resave<span class="pl-k">:</span> <span class="pl-c1">false</span>,
    saveUninitialized<span class="pl-k">:</span> <span class="pl-c1">true</span>
}));
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">req</span>, <span class="pl-smi">res</span>){
    <span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">views</span>) {
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">views</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>;
    }
    <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">views</span><span class="pl-k">++</span>;
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>hello world. <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">views</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> times so far.<span class="pl-pds">'</span></span>);
});
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">login</span>()
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>ok - <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_loggedInAt</span>);
});
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/secure<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">isLoggedIn</span>()) { <span class="pl-c">// Check if user is logged in</span>
        <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-c1">401</span>);
        <span class="pl-k">return</span>;
    }
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>Access<span class="pl-pds">'</span></span>);
});
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/secure/more<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>) {
    <span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">isFresh</span>()) { <span class="pl-c">// Check if session is fresh</span>
        <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-c1">401</span>);
        <span class="pl-k">return</span>;
    }
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>You are fresh<span class="pl-pds">'</span></span>);
});</pre></div>
</li>
<li>Use httpOnly setting for every cookie</li>
<li>If it's possible, limit cookie exposure</li>
<li>Don't cache any cookies
<code>res.header('Cache-Control', 'no-cache="Set-Cookie, Set-Cookie2"');</code>
</li>
<li>Recreate session when the user logs in
<code>javascript
session.Session.prototype.login = function login(cb) {
    var req = this.req;
    this.regenerate(function (err) {
        if(err) {
            cb(err);
            return;
        }
        req.session._loggedInAt = Date.now();
        cb();
    });
};
</code>
</li>
<li>
<p>You can bind additional info to session to prevent hijacking</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">session</span>.<span class="pl-smi">Session</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">login</span> <span class="pl-k">=</span> <span class="pl-k">function</span> <span class="pl-en">login</span>(<span class="pl-smi">cb</span>) {
    <span class="pl-k">var</span> req <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">req</span>;
    <span class="pl-v">this</span>.<span class="pl-en">regenerate</span>(<span class="pl-k">function</span> (<span class="pl-smi">err</span>) {
        <span class="pl-k">if</span>(err) {
            <span class="pl-en">cb</span>(err);
            <span class="pl-k">return</span>;
        }
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_loggedInAt</span> <span class="pl-k">=</span> <span class="pl-c1">Date</span>.<span class="pl-en">now</span>();
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_ip</span> <span class="pl-k">=</span> <span class="pl-smi">req</span>.<span class="pl-smi">ip</span>;
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_ua</span> <span class="pl-k">=</span> <span class="pl-smi">req</span>.<span class="pl-c1">headers</span>[<span class="pl-s"><span class="pl-pds">'</span>user-agent<span class="pl-pds">'</span></span>];
        <span class="pl-en">cb</span>();
    });
};
<span class="pl-c">// Check Session information</span>
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-smi">req</span>.<span class="pl-smi">session</span>) { <span class="pl-c">// If there is no session then something is wrong</span>
        <span class="pl-en">next</span>(<span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>Session object missing<span class="pl-pds">'</span></span>));
        <span class="pl-k">return</span>;
    }
    <span class="pl-k">if</span>(<span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">isGuest</span>()) { <span class="pl-c">// If not logged in then continue</span>
        <span class="pl-en">next</span>();
        <span class="pl-k">return</span>;
    }
    <span class="pl-k">if</span>(<span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_ip</span> <span class="pl-k">!==</span> <span class="pl-smi">req</span>.<span class="pl-smi">ip</span>) { <span class="pl-c">// Check ip match</span>
        <span class="pl-c">// It would be wise to log more information here</span>
        <span class="pl-c">// to either notify the user or</span>
        <span class="pl-c">// to try and prevent further attacks</span>
        <span class="pl-en">console</span>.<span class="pl-c1">warn</span>(<span class="pl-s"><span class="pl-pds">'</span>The request IP did not match session IP<span class="pl-pds">'</span></span>);
        <span class="pl-c">// Generate a new unauthenticated session</span>
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">regenerate</span>(<span class="pl-k">function</span> () {
            <span class="pl-en">next</span>();
        });
        <span class="pl-k">return</span>;
    }
    <span class="pl-k">if</span>(<span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-smi">_ua</span> <span class="pl-k">!==</span> <span class="pl-smi">req</span>.<span class="pl-c1">headers</span>[<span class="pl-s"><span class="pl-pds">'</span>user-agent<span class="pl-pds">'</span></span>]) { <span class="pl-c">// Check UA validity</span>
        <span class="pl-c">// It would be wise to log more information here</span>
        <span class="pl-c">// to either notify the user or</span>
        <span class="pl-c">// to try and prevent further attacks</span>
        <span class="pl-en">console</span>.<span class="pl-c1">warn</span>(<span class="pl-s"><span class="pl-pds">'</span>The request User Agent did not match session user agent<span class="pl-pds">'</span></span>);
        <span class="pl-c">// Generate a new unauthenticated session</span>
        <span class="pl-smi">req</span>.<span class="pl-smi">session</span>.<span class="pl-en">regenerate</span>(<span class="pl-k">function</span> () {
            <span class="pl-en">next</span>();
        });
        <span class="pl-k">return</span>;
    }
    <span class="pl-c">// Everything checks out so continue</span>
    <span class="pl-en">next</span>();
});</pre></div>

<p>Best module for session management - <code>easy-session</code></p>

<p><em>check <code>acl</code> and <code>easy-rbac</code> modules</em></p>
</li>
<li><p>Check function-level access control holes. If you have priveledged functions nobody non-authorized should know about existense of this function.The same thing with pages. Worry about client-side build pathes.Nobody non-authorized should know anything about authorized pathes.</p></li>
<li>Client side validation does not substitute for server-side validation. Don't forget about server-side validation.</li>
<li>Don't use direct references unless they are necessary.</li>
<li>Validate access rights to an object when the object is accessed.</li>
<li>Never hardcode user roles. Use custom functions to check user roles.</li>
<li>
<p>Avoid synchronous code</p>

<p><em>check Node inspector, spy.js or node webkit agent for understanding how to find performance issues</em></p>
</li>
<li><p>To avoid Denial-of-service attack you can limit amount of requests from single IP per some time.
Remember, you should check maximum requests per second for every application!!!</p></li>
<li>Disable TRACE method calls on your server</li>
<li>
<p>Set up Content Security Policy header
<code>res.header('Content-Security-Policy', "default-src 'self'");</code></p>

<p><em>check <a href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet">OWASP XSS Prevention Cheat Sheet</a></em></p>

<p><em>check <code>node-esapi</code> module and use it for sanitizing html</em></p>
</li>
<li><p>Escape untrusted data inserted into HTML element content(jade do this automatically)
<code>ESAPI.encoder().encodeForHTML(untrustedData);</code></p></li>
<li>Sanitize HTML markup
 Use <code>sanitizer</code> module and it's sanitize() function</li>
<li>Escape untrusted data inserted into HTML attributes
<code>ESAPI.encoder(),encodeForHTMLAttributes(untrustedData);</code>
Don't trust such functions as setAttribute() and other that takes code as strings. It's better to set element attribute directly.</li>
<li>Escape untrusted data inserted into JavaScript data values
<code>ESAPI.encoder().encodeForJS(untrustedData);</code> or <code>ESAPI.encoder().encodeForJavaScript(untrustedData);</code> or <code>ESAPI.encoder().encodeForJavascript(untrustedData);</code>
</li>
<li>Escape JSON values in an HTML context and read data with JSON.parse
If you want to put JSON data inside HTML do it in a such way :
<code>ESAPI.encoder().encodeForHTML(JSON.stringify(data));</code>
If you want to get this data select it and use <code>JSON.parse(jsonText)</code> NOT <code>eval(jsonText)</code>. NEVER USE EVAL!!!</li>
<li>Escape and validate untrusted data inserted into CSS property values
<code>ESAPI.encoder().encodeForCSS(untrustedData);</code>
</li>
<li>
<p>Escape untrusted data inserted into HTML URL parameter values.
<code>ESAPI.encoder().encodeForURL(untrustedData);</code></p>

<p><em>check <a href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet">OWASP DOM-based XSS Prevention Cheat Sheet</a></em></p>
</li>
<li><p>Use DOM construction methods instead of HTML interpretation.</p></li>
<li>Javascript and HTML encode nefore HTML subcontext.
 Put encoded data inside Javascript HTML render methods. You can wrap two encodings one by another:
 <code>ESAPI.encoder().encodeForJS(ESAPI.encoder().encodeForHTML(unsafeData));</code>
</li>
<li>If you are using CORS be sure to minimize permissions you allow</li>
<li>
<p>Never trust GET requests. Never allow GET requests to change anything.</p>

<p><em>check <code>csurf</code> module</em></p>
</li>
<li>
<p>To protect app from CSRF attack include csurf method and construct all forms with hidden input and csurfToken inside.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">cookieParser</span>());
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">session</span>({
        secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>this is a nice secret<span class="pl-pds">'</span></span>,
        resave<span class="pl-k">:</span> <span class="pl-c1">false</span>,
        saveUninitialized<span class="pl-k">:</span> <span class="pl-c1">true</span>
}));
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-smi">bodyParser</span>.<span class="pl-en">urlencoded</span>());
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">csurf</span>()); <span class="pl-c">// Include csurf middleware</span>
<span class="pl-c">// Show form</span>
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">var</span> form <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;form method="POST" action="/add"&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="hidden" name="_csrf" value="<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-smi">req</span>.<span class="pl-en">csrfToken</span>() <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c">// add hidden token field</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="text" name="name" placeholder="name" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="text" name="value" placeholder="value" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="submit" value="Submit" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                <span class="pl-s"><span class="pl-pds">'</span>&lt;/form&gt;<span class="pl-pds">'</span></span>;
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(form);
});</pre></div>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// error handler</span>
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-k">function</span> (<span class="pl-smi">err</span>, <span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">if</span> (<span class="pl-smi">err</span>.<span class="pl-c1">code</span> <span class="pl-k">!==</span> <span class="pl-s"><span class="pl-pds">'</span>EBADCSRFTOKEN<span class="pl-pds">'</span></span>) {
        <span class="pl-k">return</span> <span class="pl-en">next</span>(err) <span class="pl-c">// some other error</span>
    }
    <span class="pl-c">// handle CSRF token errors here</span>
    <span class="pl-c">// Besides just saying that we had a mismatch</span>
    <span class="pl-c">// we should log some useful information about the request here</span>
    <span class="pl-c">// like the user and referrer and origin headers of the request for example</span>
    <span class="pl-en">console</span>.<span class="pl-c1">warn</span>(<span class="pl-s"><span class="pl-pds">'</span>CSRF token mismatch<span class="pl-pds">'</span></span>);
    <span class="pl-smi">res</span>.<span class="pl-c1">status</span>(<span class="pl-c1">403</span>)
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(<span class="pl-s"><span class="pl-pds">'</span>form tampered with<span class="pl-pds">'</span></span>)
});</pre></div>

<p>Also you can use double-submit cookie with csurfToken</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// Include csurf middleware, with cookie option</span>
<span class="pl-smi">app</span>.<span class="pl-en">use</span>(<span class="pl-en">csurf</span>({cookie<span class="pl-k">:</span> <span class="pl-c1">true</span>}));
<span class="pl-c">// Show form</span>
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">req</span>, <span class="pl-smi">res</span>, <span class="pl-smi">next</span>) {
    <span class="pl-k">var</span> form <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;form method="POST" action="/add"&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="hidden" name="_csrf" value="<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-smi">req</span>.<span class="pl-en">csrfToken</span>() <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c">// add hidden token field</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="text" name="name" placeholder="name" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="text" name="value" placeholder="value" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                    <span class="pl-s"><span class="pl-pds">'</span>&lt;input type="submit" value="Submit" /&gt;<span class="pl-pds">'</span></span> <span class="pl-k">+</span>
                <span class="pl-s"><span class="pl-pds">'</span>&lt;/form&gt;<span class="pl-pds">'</span></span>;
    <span class="pl-smi">res</span>.<span class="pl-c1">send</span>(form);
});</pre></div>

<p>Protect all your forms, not only authentication
If you want to defeat CSRF attack, then you need to master XSS first</p>
</li>
<li>When you are using forms collecting sensitive information, you should either turn off autocomplete entirely.</li>
<li>Set cache control header not to cache pages with sensitive info
<code>res.header('Cache-Control', 'no-store');</code>
But think carefully where to use it. no-cache header increases server load.</li>
<li>Never log any sensitive info.You can log it only after masking it</li>
<li>Try to open as few directories as possible or check all info you use as "public". Limit public access folders.</li>
<li>Check valid paths when user gets any file.Also check it when user puts any file, too.</li>
<li>
<p>If you want to save data propperly, you should encrypt it first. But it's not good to encrypt everything with one key, so you should generate random key for every user,then encrypt data with this key, then encrypt this key with user password and store both encrypted data and encrypted key in store.When user want to get data use it's password to decrypt key, then decrypt data, then give that data to user.
 BUT, DON'T ENCRYPT EVERYTHING!Encryption is very resource-heavy process.Encrypt only sensitive data.</p>

<p><em>check <a href="https://www.owasp.org/index.php/OWASP_Risk_Rating_Methodology">OWASP Risk rating methodology</a></em></p>

<p><em>check <a href="https://www.owasp.org/index.php/Threat_Risk_Modeling">OWASP Threat Risk Modeling</a></em></p>
</li>
<li><p>Use <code>helmet</code> module</p></li>
<li>
<p>Use <code>nsp</code> module to check if you are using some modules, which are vulnerable</p>

<p><em>check <a href="https://www.owasp.org/images/5/58/OWASP_ASVS_Version_2.pdf">OWASP Application Security Verification Standard</a></em></p>
</li>
<li>
<p>Use non standard password match algorythm to defend against timing attack</p>

<p><em>check <a href="https://snyk.io/blog/node-js-timing-attack-ccc-ctf/">Node.JS timing</a></em></p>

<p><em>check <a href="https://github.com/OWASP/NodeGoat">OWASP NodeGoat Tutorial</a></em></p>

<p><em>check <a href="https://www.owasp.org/index.php/Web_Application_Security_Testing_Cheat_Sheet">OWASP Web Application Security Testing Cheat Sheet</a></em></p>

<p><em>check Hacking: The Art of Exploitation book</em></p>
</li>
<li><p>Use metasploit or Kali or burp to check security (<a href="http://www.metasploit.com/">http://www.metasploit.com/</a>   <a href="https://www.kali.org/">https://www.kali.org/</a>   <a href="https://portswigger.net/burp/">https://portswigger.net/burp/</a>)</p></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/NikitaLiashenko/NodeJSWebSecurity.github.io">nodejswebsecurity.github.io</a> is maintained by <a href="https://github.com/NikitaLiashenko">NikitaLiashenko</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
